const path = require('path');
const fs = require('fs-extra');

const compiledDir = path.resolve(__dirname, '../compiled');
fs.removeSync(compiledDir);
fs.ensureDirSync(compiledDir);

const solc = require('solc');

const safeMathPath = path.resolve(
    __dirname,
    'node_modules/@openzeppelin/contracts/utils/math/',
    'SafeMath.sol'
);

function findImports(importPath) {
    if (importPath === '@openzeppelin/contracts/utils/math/SafeMath.sol') {
        return {contents: fs.readFileSync(safeMathPath, 'utf8')};
    }
    return {error: 'File not found'};
}

function compile() {
    const contractPath = path.resolve(__dirname, 'contracts', 'Amm.sol');
    const contractSource = fs.readFileSync(contractPath, 'utf8');

    const input = {
        language: 'Solidity',
        sources: {
            'Amm.sol': {
                content: contractSource,
            },
            'SafeMath.sol': {
                content: fs.readFileSync(safeMathPath, 'utf8'),
            },
        },
        settings: {
            outputSelection: {
                '*': {
                    '*': ['*'],
                },
            },
        },
    };
    const bytecode = '608060405234801561001057600080fd5b50336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550611df6806100606000396000f3fe608060405234801561001057600080fd5b50600436106101005760003560e01c8063aca34c1111610097578063e8c3c54f11610066578063e8c3c54f14610327578063f0fa55a914610357578063f4cb34d414610373578063f9813798146103a457610100565b8063aca34c1114610276578063b324404114610296578063d212b440146102c7578063d3817b4a146102f757610100565b80634a92c260116100d35780634a92c260146101c65780637565a92b146101f657806391e0dbb814610226578063980d69d31461024657610100565b8063078b7fdc146101055780632e1a7d4d14610135578063319bb38f14610166578063450177c614610196575b600080fd5b61011f600480360381019061011a919061175e565b6103c0565b60405161012c919061179a565b60405180910390f35b61014f600480360381019061014a919061175e565b610436565b60405161015d9291906117b5565b60405180910390f35b610180600480360381019061017b919061175e565b6106c7565b60405161018d919061179a565b60405180910390f35b6101b060048036038101906101ab919061175e565b61073d565b6040516101bd919061179a565b60405180910390f35b6101e060048036038101906101db91906117de565b6107eb565b6040516101ed919061179a565b60405180910390f35b610210600480360381019061020b919061175e565b610863565b60405161021d919061179a565b60405180910390f35b61022e61093d565b60405161023d9392919061181e565b60405180910390f35b610260600480360381019061025b919061175e565b610a0d565b60405161026d919061179a565b60405180910390f35b61027e610c0a565b60405161028d9392919061181e565b60405180910390f35b6102b060048036038101906102ab919061175e565b610c23565b6040516102be9291906117b5565b60405180910390f35b6102e160048036038101906102dc919061175e565b610d0b565b6040516102ee919061179a565b60405180910390f35b610311600480360381019061030c919061175e565b610de5565b60405161031e919061179a565b60405180910390f35b610341600480360381019061033c91906117de565b610e93565b60405161034e919061179a565b60405180910390f35b610371600480360381019061036c919061175e565b61129d565b005b61038d6004803603810190610388919061175e565b6112e4565b60405161039b9291906117b5565b60405180910390f35b6103be60048036038101906103b991906117de565b61159d565b005b60008060015411610406576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016103fd906118b2565b60405180910390fd5b61042f600354610421846002546116cb90919063ffffffff16565b6116e190919063ffffffff16565b9050919050565b60008060006001541161047e576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610475906118b2565b60405180910390fd5b600683600081116104c4576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104bb9061191e565b60405180910390fd5b8160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054811115610545576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161053c9061198a565b60405180910390fd5b61054e85610c23565b809450819550505084600660003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546105a591906119d9565b9250508190555084600160008282546105be91906119d9565b9250508190555083600260008282546105d791906119d9565b9250508190555082600360008282546105f091906119d9565b9250508190555061060e6003546002546116cb90919063ffffffff16565b60048190555083600760003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546106639190611a0d565b9250508190555082600860003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546106b99190611a0d565b925050819055505050915091565b6000806001541161070d576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610704906118b2565b60405180910390fd5b610736600254610728846003546116cb90919063ffffffff16565b6116e190919063ffffffff16565b9050919050565b60008060015411610783576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161077a906118b2565b60405180910390fd5b600061079a836002546116f790919063ffffffff16565b905060006107b3826004546116e190919063ffffffff16565b90506107ca8160035461170d90919063ffffffff16565b925060035483036107e45782806107e090611a41565b9350505b5050919050565b600080836002546107fc9190611a0d565b905060008360035461080e91906119d9565b90506000818361081e9190611a99565b90506064600161082e9190611aca565b61084e6064600161083f9190611aca565b836116e190919063ffffffff16565b61085891906119d9565b935050505092915050565b600080600154116108a9576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016108a0906118b2565b60405180910390fd5b60025482106108ed576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016108e490611b58565b60405180910390fd5b60006109048360025461170d90919063ffffffff16565b9050600061091d826004546116e190919063ffffffff16565b90506109346003548261170d90919063ffffffff16565b92505050919050565b6000806000600760003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549250600860003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549150600660003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050909192565b60008060015411610a53576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610a4a906118b2565b60405180910390fd5b60088260008111610a99576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610a909061191e565b60405180910390fd5b8160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054811115610b1a576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610b119061198a565b60405180910390fd5b610b2384610de5565b925083600860003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254610b7491906119d9565b925050819055508360036000828254610b8d9190611a0d565b925050819055508260026000828254610ba691906119d9565b9250508190555082600760003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254610bfc9190611a0d565b925050819055505050919050565b6000806000600254600354600154925092509250909192565b600080600060015411610c6b576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610c62906118b2565b60405180910390fd5b600154831115610cb0576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610ca790611bea565b60405180910390fd5b610cd9600154610ccb600254866116cb90919063ffffffff16565b6116e190919063ffffffff16565b9150610d04600154610cf6600354866116cb90919063ffffffff16565b6116e190919063ffffffff16565b9050915091565b60008060015411610d51576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610d48906118b2565b60405180910390fd5b6003548210610d95576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610d8c90611b58565b60405180910390fd5b6000610dac8360035461170d90919063ffffffff16565b90506000610dc5826004546116e190919063ffffffff16565b9050610ddc6002548261170d90919063ffffffff16565b92505050919050565b60008060015411610e2b576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610e22906118b2565b60405180910390fd5b6000610e42836003546116f790919063ffffffff16565b90506000610e5b826004546116e190919063ffffffff16565b9050610e728160025461170d90919063ffffffff16565b92506002548303610e8c578280610e8890611a41565b9350505b5050919050565b600060078360008111610edb576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610ed29061191e565b60405180910390fd5b8160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054811115610f5c576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610f539061198a565b60405180910390fd5b60088460008111610fa2576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610f999061191e565b60405180910390fd5b8160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054811115611023576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161101a9061198a565b60405180910390fd5b60006001540361104457620f4240606461103d9190611aca565b94506110e6565b600061106f6002546110618a6001546116cb90919063ffffffff16565b6116e190919063ffffffff16565b9050600061109c60035461108e8a6001546116cb90919063ffffffff16565b6116e190919063ffffffff16565b90508082146110e0576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016110d790611c7c565b60405180910390fd5b81965050505b60008511611129576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161112090611d0e565b60405180910390fd5b86600760003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825461117891906119d9565b9250508190555085600860003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546111ce91906119d9565b9250508190555086600260008282546111e79190611a0d565b9250508190555085600360008282546112009190611a0d565b9250508190555061121e6003546002546116cb90919063ffffffff16565b60048190555084600160008282546112369190611a0d565b9250508190555084600660003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825461128c9190611a0d565b925050819055505050505092915050565b80600560003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555050565b60008060006001541161132c576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611323906118b2565b60405180910390fd5b60078360008111611372576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016113699061191e565b60405180910390fd5b8160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020548111156113f3576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016113ea9061198a565b60405180910390fd5b6113fc8561073d565b93506000600560003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905061144c86866107eb565b93506114626064856116cb90919063ffffffff16565b6114766064836116cb90919063ffffffff16565b10156114b7576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016114ae90611da0565b60405180910390fd5b85600760003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825461150691906119d9565b92505081905550856002600082825461151f9190611a0d565b92505081905550846003600082825461153891906119d9565b9250508190555084600860003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825461158e9190611a0d565b92505081905550505050915091565b6115ef82600760003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020546116f790919063ffffffff16565b600760003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555061168481600860003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020546116f790919063ffffffff16565b600860003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055505050565b600081836116d99190611aca565b905092915050565b600081836116ef9190611a99565b905092915050565b600081836117059190611a0d565b905092915050565b6000818361171b91906119d9565b905092915050565b600080fd5b6000819050919050565b61173b81611728565b811461174657600080fd5b50565b60008135905061175881611732565b92915050565b60006020828403121561177457611773611723565b5b600061178284828501611749565b91505092915050565b61179481611728565b82525050565b60006020820190506117af600083018461178b565b92915050565b60006040820190506117ca600083018561178b565b6117d7602083018461178b565b9392505050565b600080604083850312156117f5576117f4611723565b5b600061180385828601611749565b925050602061181485828601611749565b9150509250929050565b6000606082019050611833600083018661178b565b611840602083018561178b565b61184d604083018461178b565b949350505050565b600082825260208201905092915050565b7f5a65726f204c6971756964697479000000000000000000000000000000000000600082015250565b600061189c600e83611855565b91506118a782611866565b602082019050919050565b600060208201905081810360008301526118cb8161188f565b9050919050565b7f416d6f756e742063616e6e6f74206265207a65726f2100000000000000000000600082015250565b6000611908601683611855565b9150611913826118d2565b602082019050919050565b60006020820190508181036000830152611937816118fb565b9050919050565b7f496e73756666696369656e7420616d6f756e7400000000000000000000000000600082015250565b6000611974601383611855565b915061197f8261193e565b602082019050919050565b600060208201905081810360008301526119a381611967565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006119e482611728565b91506119ef83611728565b9250828203905081811115611a0757611a066119aa565b5b92915050565b6000611a1882611728565b9150611a2383611728565b9250828201905080821115611a3b57611a3a6119aa565b5b92915050565b6000611a4c82611728565b915060008203611a5f57611a5e6119aa565b5b600182039050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b6000611aa482611728565b9150611aaf83611728565b925082611abf57611abe611a6a565b5b828204905092915050565b6000611ad582611728565b9150611ae083611728565b9250828202611aee81611728565b91508282048414831517611b0557611b046119aa565b5b5092915050565b7f496e73756666696369656e7420706f6f6c2062616c616e636500000000000000600082015250565b6000611b42601983611855565b9150611b4d82611b0c565b602082019050919050565b60006020820190508181036000830152611b7181611b35565b9050919050565b7f53686172652073686f756c64206265206c657373207468616e20746f74616c5360008201527f6861726500000000000000000000000000000000000000000000000000000000602082015250565b6000611bd4602483611855565b9150611bdf82611b78565b604082019050919050565b60006020820190508181036000830152611c0381611bc7565b9050919050565b7f4571756976616c656e742076616c7565206f6620746f6b656e73206e6f74207060008201527f726f76696465642e2e2e00000000000000000000000000000000000000000000602082015250565b6000611c66602a83611855565b9150611c7182611c0a565b604082019050919050565b60006020820190508181036000830152611c9581611c59565b9050919050565b7f41737365742076616c7565206c657373207468616e207468726573686f6c642060008201527f666f7220636f6e747269627574696f6e21000000000000000000000000000000602082015250565b6000611cf8603183611855565b9150611d0382611c9c565b604082019050919050565b60006020820190508181036000830152611d2781611ceb565b9050919050565b7f557365722073657420736c69707061676520686173206265656e20737572706160008201527f7373656400000000000000000000000000000000000000000000000000000000602082015250565b6000611d8a602483611855565b9150611d9582611d2e565b604082019050919050565b60006020820190508181036000830152611db981611d7d565b905091905056fea2646970667358221220764c5cc5ba4e00cb39733bc4ddf28f17bb0ecd7290815999ecd674a5104eca7564736f6c63430008120033'

    const output = JSON.parse(solc.compile(JSON.stringify(input), {import: findImports}));
    const contractBytecode = output.contracts['Amm.sol'].AMM.evm.bytecode.object;
    console.log(contractBytecode == bytecode)
    // console.log(output);
    module.exports = output.contracts['Amm.sol'].AMM
}

compile();
